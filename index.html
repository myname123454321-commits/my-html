<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stan - 控雨时刻 (暴雨版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* 标题 */
        #title-overlay {
            position: absolute; width: 100%; top: 15%; text-align: center; pointer-events: none; z-index: 5;
            transition: opacity 0.5s;
        }
        h1 {
            font-family: 'Cinzel', serif; 
            color: #ffffff; 
            font-size: 5rem; 
            margin: 0;
            letter-spacing: 15px;
            text-transform: uppercase;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8);
            opacity: 1;
        }
        p.subtitle {
            color: #aaa; font-size: 1.5rem; letter-spacing: 5px; margin-top: 10px; text-transform: uppercase;
        }

        /* 摄像头小窗 */
        #camera-container {
            position: absolute; top: 20px; left: 20px; width: 240px; height: 180px; z-index: 20;
            border-radius: 4px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8); transform: scaleX(-1);
            background: #000;
        }
        .input_video { position: absolute; width: 100%; height: 100%; object-fit: cover; opacity: 1; } 
        .output_canvas { position: absolute; width: 100%; height: 100%; }

        /* 启动遮罩 */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer;
        }
        #start-screen h2 { color: white; font-family: 'Cinzel'; font-size: 3rem; margin-bottom: 20px; text-shadow: 0 0 20px white;}
        #start-screen p { color: #ccc; font-size: 1.2rem;}

        #guide-panel {
            position: absolute; bottom: 40px; width: 100%; text-align: center; color: rgba(255,255,255,0.6); z-index: 10;
            pointer-events: none; font-size: 1.1rem; letter-spacing: 3px;
        }
        .key { color: #fff; border-bottom: 2px solid #fff; padding-bottom: 2px; font-weight: bold;}

        #canvas-container { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        #loading { display:none; } 
    </style>
</head>
<body>
    <div id="start-screen">
        <h2>CLICK TO START</h2>
        <p>点击屏幕 · 唤醒暴雨</p>
    </div>

    <audio id="bgm" loop>
        <source src="./M800004WDS6p3EeOIq.mp3" type="audio/mp3">
    </audio>

    <div id="title-overlay">
        <h1>STAN</h1>
        <p class="subtitle">Rain Control</p>
    </div>

    <div id="camera-container">
        <video class="input_video"></video>
        <canvas class="output_canvas"></canvas>
    </div>

    <div id="guide-panel">
        <span class="key">✊ 握拳</span> 暴雨 &nbsp;&nbsp;&nbsp;&nbsp; 
        <span class="key">✋ 张开</span> 静止
    </div>

    <div id="canvas-container"></div>

<script>
    // ================= 1. 核心配置 =================
    const RAIN_COUNT = 12000; 
    const RAIN_SPEED_BASE = 1.8; // [加强] 速度更快，更像暴雨
    
    // ================= 2. 场景初始化 =================
    const scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.005); // 雾气调淡，让远处的雨也清晰
    
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 0, 25); // 视角稍微拉远
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // ================= 3. 电影级高亮雨滴 (增强可视度) =================
    function createRainTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 64;  // [加强] 纹理变宽
        canvas.height = 512; // [加强] 纹理变长，拉丝感更强
        const ctx = canvas.getContext('2d');

        const gradient = ctx.createLinearGradient(0, 0, 0, 512);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0)'); // 尾巴透明
        gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.2)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 1.0)'); // 头部纯白高亮

        ctx.fillStyle = gradient;
        // 画一个更粗的雨滴
        ctx.fillRect(28, 0, 8, 512); 

        const texture = new THREE.Texture(canvas);
        texture.needsUpdate = true;
        return texture;
    }

    const rainGeometry = new THREE.BufferGeometry();
    const rainPositions = new Float32Array(RAIN_COUNT * 3);
    const rainVelocities = new Float32Array(RAIN_COUNT); 
    
    for (let i = 0; i < RAIN_COUNT; i++) {
        const i3 = i * 3;
        // 缩窄 X 和 Z 范围，让雨滴更集中在屏幕中间
        rainPositions[i3] = (Math.random() - 0.5) * 160;
        rainPositions[i3+1] = (Math.random() - 0.5) * 120;
        rainPositions[i3+2] = (Math.random() - 0.5) * 120;
        
        rainVelocities[i] = 0.8 + Math.random() * 0.4;
    }
    
    rainGeometry.setAttribute('position', new THREE.BufferAttribute(rainPositions, 3));

    const rainMaterial = new THREE.PointsMaterial({
        color: 0xffffff, // 纯白，对比度最高
        size: 1.5,       // [加强] 尺寸大幅增加 (原0.3 -> 1.5)，确保看得清
        map: createRainTexture(), 
        transparent: true,
        opacity: 0.9,    // [加强] 不透明度提高
        blending: THREE.AdditiveBlending, // 发光叠加，越重叠越亮
        depthWrite: false,
        sizeAttenuation: true 
    });

    const rainSystem = new THREE.Points(rainGeometry, rainMaterial);
    scene.add(rainSystem);

    // 灯光增强
    const ambientLight = new THREE.AmbientLight(0x444444);
    scene.add(ambientLight);
    // 加一个顶光，照亮雨滴
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(0, 50, 10);
    scene.add(dirLight);

    // ================= 4. 音频与交互 =================
    const bgm = document.getElementById('bgm');
    let isExperienceStarted = false;

    document.getElementById('start-screen').addEventListener('click', () => {
        document.getElementById('start-screen').style.opacity = '0';
        setTimeout(() => document.getElementById('start-screen').style.display = 'none', 500);
        
        isExperienceStarted = true;
        bgm.play().then(() => console.log("Music started")).catch(e => console.error(e));
        cameraUtils.start();
    });

    // ================= 5. 手势识别 =================
    let handState = 'fist'; 
    
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');

    function onResults(results) {
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            
            // 骨骼绘制：白色高亮，方便看清
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: 'rgba(255, 255, 255, 0.8)', lineWidth: 2});
            drawLandmarks(canvasCtx, landmarks, {color: 'rgba(0, 200, 255, 1)', lineWidth: 2, radius: 3});

            const wrist = landmarks[0];
            const tips = [8, 12, 16, 20];
            let dist = 0;
            tips.forEach(i => dist += Math.hypot(landmarks[i].x - wrist.x, landmarks[i].y - wrist.y));
            handState = (dist / 4) > 0.35 ? 'open' : 'fist';

        } else {
            handState = 'fist'; 
        }
    }

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 320, height: 240
    });

    // ================= 6. 动画主循环 =================
    let currentSpeed = RAIN_SPEED_BASE;
    let time = 0;

    function animate() {
        requestAnimationFrame(animate);
        time += 0.01;

        if (!isExperienceStarted) {
            renderer.render(scene, camera);
            return;
        }

        let targetSpeed = RAIN_SPEED_BASE;

        if (handState === 'open') {
            targetSpeed = 0; // 悬停
            if (!bgm.paused) bgm.pause();
        } else {
            targetSpeed = RAIN_SPEED_BASE; // 下雨
            if (bgm.paused) bgm.play();
        }

        // 速度响应快一点，0.1 -> 0.15
        currentSpeed += (targetSpeed - currentSpeed) * 0.15;

        const positions = rainSystem.geometry.attributes.position.array;

        for (let i = 0; i < RAIN_COUNT; i++) {
            const i3 = i * 3;
            
            positions[i3 + 1] -= currentSpeed * rainVelocities[i];

            // 循环边界
            if (positions[i3 + 1] < -60) {
                positions[i3 + 1] = 60;
            }

            // 悬停微颤：幅度加大一点，让悬停感更明显
            if (currentSpeed < 0.1) {
                positions[i3 + 1] += Math.sin(time * 3 + i) * 0.01; 
            }
        }
        
        rainSystem.geometry.attributes.position.needsUpdate = true;

        // 相机运动
        camera.position.y += Math.sin(time * 0.3) * 0.01;
        camera.rotation.z = Math.sin(time * 0.1) * 0.002;

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
</script>
</body>
</html>
